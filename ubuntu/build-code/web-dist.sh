#!/bin/bash
set -euo pipefail  # ä¸¥æ ¼æ¨¡å¼ï¼šé”™è¯¯ç«‹å³é€€å‡ºï¼Œæœªå®šä¹‰å˜é‡æŠ¥é”™

# PNPM_VERSIONçš„è¯´æ˜Ž
# ç¬¦å·	ç¤ºä¾‹	å«ä¹‰ï¼ˆä»¥ 9.12.0 ä¸ºä¾‹ï¼‰	é€‚ç”¨åœºæ™¯
# ^	^9.12	>=9.12.0 <10.0.0ï¼ˆä¸»ç‰ˆæœ¬é”å®šï¼‰	å…è®¸åŠŸèƒ½æ–°å¢ž + bug ä¿®å¤
# ~	~9.12	>=9.12.0 <9.13.0ï¼ˆæ¬¡ç‰ˆæœ¬é”å®šï¼‰	ä»…å…è®¸ bug ä¿®å¤ï¼Œä¸æ–°å¢žåŠŸèƒ½
# æ— 	9.12.0	ç²¾ç¡®å®‰è£… 9.12.0ï¼ˆæ— æ›´æ–°ï¼‰	è¦æ±‚ç‰ˆæœ¬ç»å¯¹å›ºå®š
# *	*	å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼ˆä»»æ„ä¸»ç‰ˆæœ¬ï¼‰	ä¸ä»‹æ„ç‰ˆæœ¬ï¼Œåªæ±‚æœ€æ–°

# ===================== é…ç½®é¡¹ï¼ˆå½“å‰ç›®å½•è¿è¡Œï¼Œæžç®€è·¯å¾„ï¼‰ =====================
CONTAINER_WORKDIR="/app"  # å®¹å™¨å†…æŒ‚è½½ç›®å½•ï¼ˆå¯¹åº”å®¿ä¸»æœºå½“å‰ç›®å½•ï¼‰
NODE_VERSION="20.10.0"    # Nodeç‰ˆæœ¬
PNPM_VERSION="^9.12"      # pnpmç‰ˆæœ¬

# ===================== å‰ç½®æ£€æŸ¥ =====================
# æ£€æŸ¥å½“å‰ç›®å½•æ˜¯å¦å­˜åœ¨ï¼ˆç†è®ºä¸Šå¿…å­˜åœ¨ï¼Œå…œåº•æ£€æŸ¥ï¼‰
if [ ! -d "./" ]; then
    echo "âŒ é”™è¯¯ï¼šå½“å‰ç›®å½•ä¸å­˜åœ¨ï¼ˆå¼‚å¸¸ï¼‰"
    exit 1
fi

# æ£€æŸ¥package.jsonæ˜¯å¦å­˜åœ¨ï¼ˆå‰ç«¯é¡¹ç›®æ ¸å¿ƒæ–‡ä»¶ï¼‰
if [ ! -f "./package.json" ]; then
    echo "âŒ é”™è¯¯ï¼šå½“å‰ç›®å½•æœªæ‰¾åˆ°package.jsonï¼Œè¯·ç¡®è®¤åœ¨å‰ç«¯é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ"
    exit 1
fi

echo "âœ… å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹æž„å»ºå‰ç«¯ä»£ç ..."

# ===================== æ ¸å¿ƒæž„å»ºé€»è¾‘ =====================
docker run --rm --name build-web \
    -v "$(pwd):${CONTAINER_WORKDIR}" \
    -w "${CONTAINER_WORKDIR}" \
    node:${NODE_VERSION} \
    /bin/bash -c "
        set -euo pipefail
        # å®‰è£…pnpmï¼ˆå›½å†…æºåŠ é€Ÿï¼‰
        echo 'ðŸ“¦ å®‰è£…pnpm@${PNPM_VERSION}...'
        npm install -g pnpm@${PNPM_VERSION} --registry=https://registry.npmmirror.com
        
        # å®‰è£…ä¾èµ–ï¼ˆç”¨pnpmï¼Œæ›¿ä»£npm install -fï¼Œæ›´è§„èŒƒï¼‰
        echo 'ðŸ”§ å®‰è£…é¡¹ç›®ä¾èµ–...'
        pnpm install
        
        # æ‰§è¡Œæž„å»º
        echo 'ðŸš€ æ‰§è¡Œå‰ç«¯æž„å»º...'
        pnpm run build
        
        # æ£€æŸ¥æž„å»ºç»“æžœï¼ˆå®¹å™¨å†…/app/dist = å®¿ä¸»æœº./distï¼‰
        if [ -d '${CONTAINER_WORKDIR}/dist' ]; then
            echo 'âœ… æž„å»ºæˆåŠŸï¼šdistç›®å½•å·²ç”Ÿæˆ'
        else
            echo 'âŒ é”™è¯¯ï¼šæž„å»ºå¤±è´¥ï¼Œæœªç”Ÿæˆdistç›®å½•'
            exit 1
        fi
    "

# ===================== ç»“æžœéªŒè¯ =====================
# éªŒè¯å®¿ä¸»æœºdistç›®å½•ï¼ˆå®¹å™¨å†…ç»“æžœå·²åŒæ­¥ï¼ŒäºŒæ¬¡å…œåº•æ£€æŸ¥ï¼‰
if [ -d "./dist" ]; then
    echo -e "\nðŸŽ‰ æ“ä½œå®Œæˆï¼"
    echo "âœ… æž„å»ºäº§ç‰©ç›®å½•ï¼š$(pwd)/dist"
    echo "ðŸ” ç›®å½•å†…å®¹ï¼š"
    ls -la ./dist | head -10  # å±•ç¤ºå‰10è¡Œï¼Œä¾¿äºŽéªŒè¯
else
    echo -e "\nâŒ æž„å»ºç»“æžœå¼‚å¸¸ï¼šå®¿ä¸»æœºæœªæ‰¾åˆ°distç›®å½•"
    exit 1
fi
