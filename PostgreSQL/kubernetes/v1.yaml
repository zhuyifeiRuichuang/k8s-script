---
# 配置专用namesapce
apiVersion: v1
kind: Namespace
metadata:
  name: bigdata5
---
# 1. 集群内访问：Headless Service
apiVersion: v1
kind: Service
metadata:
  name: postgresql-headless
  namespace: bigdata5
  labels:
    app: postgresql
spec:
  selector:
    app: postgresql
  clusterIP: None
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
---
# 2. 集群外访问：NodePort Service
apiVersion: v1
kind: Service
metadata:
  name: postgresql-nodeport
  namespace: bigdata5
  labels:
    app: postgresql
spec:
  selector:
    app: postgresql
  type: NodePort
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
      #nodePort: 30432
  sessionAffinity: ClientIP
---
# 3. StatefulSet 部署
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql
  namespace: bigdata5
spec:
  serviceName: postgresql-headless
  replicas: 1
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      containers:
        - name: postgresql
          image: postgres:18.1
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 5432
              name: postgresql
          env:
            - name: POSTGRES_USER
              value: "hive"
            - name: POSTGRES_PASSWORD
              value: "hive"
            - name: POSTGRES_DB
              value: "metastore_db"
            - name: TZ
              value: "Asia/Shanghai"
            - name: POSTGRES_INITDB_ARGS
              value: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
            - name: POSTGRES_HOST_AUTH_METHOD
              value: "md5"
          resources:
            requests:
              cpu: "1"
              memory: "2Gi"
            limits:
              cpu: "2"
              memory: "4Gi"
          startupProbe:
            exec:
              command: ["pg_isready", "-U", "hive", "-d", "metastore_db", "-h", "localhost"]
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          livenessProbe:
            exec:
              command: ["pg_isready", "-U", "hive", "-d", "metastore_db", "-h", "localhost"]
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            exec:
              command: ["pg_isready", "-U", "hive", "-d", "metastore_db", "-h", "localhost"]
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: postgresql-data
              mountPath: /var/lib/postgresql
            - name: localtime
              mountPath: /etc/localtime
              readOnly: true
          args:
            - "-c"
            - "max_connections=1000"
            - "-c"
            - "shared_buffers=1GB"
            - "-c"
            - "work_mem=32MB"
            - "-c"
            - "maintenance_work_mem=256MB"
            - "-c"
            - "effective_cache_size=3GB"
            - "-c"
            - "checkpoint_completion_target=0.9"
            - "-c"
            - "wal_buffers=16MB"
            - "-c"
            - "default_statistics_target=100"
            - "-c"
            - "log_min_messages=warning"
            - "-c"
            - "log_rotation_size=100MB"
            - "-c"
            - "log_directory=/var/lib/postgresql/18/main/logs"
            - "-c"
            - "listen_addresses=*"
      volumes:
        - name: localtime
          hostPath:
            path: /etc/localtime
            type: File
  volumeClaimTemplates:
    - metadata:
        name: postgresql-data
        namespace: bigdata5
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: "local"
        resources:
          requests:
            storage: "10Gi"
